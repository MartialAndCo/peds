generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


enum Role {
  ADMIN
  COLLABORATOR
  PROVIDER
}

enum LeadType {
  WHATSAPP
  DISCORD
}

enum LeadStatus {
  PENDING    // New lead, not yet processed
  IMPORTED   // Converted to Contact in the system
  CONVERTED  // Became a paying customer
  REJECTED   // Bad lead
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  agents    Agent[]
  leads     Lead[]  // Leads added by this provider
  providerConfig ProviderConfig?
}

model Prompt {
  id            Int      @id @default(autoincrement())
  name          String
  system_prompt String
  model         String   @default("venice-uncensored")
  temperature   Decimal  @default(0.7)
  max_tokens    Int      @default(500)
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  conversations Conversation[]
  agentPrompts  AgentPrompt[]

  @@map("prompts")
}

model Contact {
  id              String         @id @default(cuid())
  phone_whatsapp  String?        @unique
  discordId       String?        @unique // Discord User ID for cross-platform linking
  name            String?
  source          String?        @default("manual")
  notes           String?
  status          String         @default("new") // active, archive, blacklisted, merged
  testMode        Boolean        @default(false) // Bypass AI delays for testing
  
  // Merge tracking - if this contact was merged into another
  mergedIntoId    String?        // ID of the contact this was merged into
  
  // State-Aware Agent Fields
  agentPhase      String         @default("CONNECTION") // CONNECTION, VULNERABILITY, CRISIS
  trustScore      Int            @default(0)
  lastPhaseUpdate DateTime       @default(now())
  lastTrustAnalysis DateTime     @default(now())
  lastProfileUpdate DateTime?    // Last time profile was extracted
  
  profile         Json?          // Stores extracted info: { age, job, location, name, ... }

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  conversations   Conversation[]
  payments        Payment[]
  messageQueue    MessageQueue[]
  trustLogs       TrustLog[]
  paymentClaims   PendingPaymentClaim[]
  agentContacts   AgentContact[]
  pendingVoiceValidations PendingVoiceValidation[]
  supervisorAlerts SupervisorAlert[]
  lead            Lead?          // Associated lead if created via provider

  @@index([status])
  @@index([source])
  @@index([agentPhase])
  @@index([mergedIntoId])
  @@map("contacts")
}


model Agent {
  id        String   @id @default(cuid())
  name      String   // e.g. "Lena", "Maxime"
  phone     String   @unique // The WhatsApp number connected to this agent
  color     String   @default("#000000") // For UI distinction
  isActive  Boolean  @default(true)
  
  // Legacy field, helpful for migration or default fallback
  promptId  Int?     

  voiceModelId Int?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id])
  operatorGender String   @default("MALE") // 'MALE', 'FEMALE'
  language     String   @default("Auto") // TTS language: Auto, English, French, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversations Conversation[]
  agentPrompts  AgentPrompt[]
  settings      AgentSetting[]
  blacklistRules BlacklistRule[]
  events        AgentEvent[]
  
  // Multi-agent relations
  trustLogs       TrustLog[]
  paymentClaims   PendingPaymentClaim[]
  notifications   Notification[]
  
  users         User[] // Access control
  
  profile       AgentProfile?
  agentContacts AgentContact[]
  pendingVoiceValidations PendingVoiceValidation[]
  discordBots   DiscordBot[]
  leads         Lead[] // Leads assigned to this agent
  providerConfigs ProviderConfig[] // Providers assigned to this agent

  @@map("agents")
}

model AgentEvent {
  id          Int      @id @default(autoincrement())
  agentId     String
  title       String   // e.g. "Trip to Bali", "Prom"
  location    String   // e.g. "Bali", "Paris"
  startDate   DateTime
  endDate     DateTime? // If null, single day event
  description String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([startDate])
  @@map("agent_events")
}

model VoiceModel {
  id             Int      @id @default(autoincrement())
  name           String   // e.g. "Lena Voice", "Emma Voice"
  voiceSampleUrl String   // Supabase storage URL of voice sample (3-30 sec)
  gender         String   @default("FEMALE") // 'MALE', 'FEMALE'
  language       String   @default("Auto") // Auto, English, French, Chinese, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  agents    Agent[]
  generations VoiceGeneration[]

  @@map("voice_models")
}

model VoiceGeneration {
  id            Int        @id @default(autoincrement())
  voiceModelId  Int?
  voiceModel    VoiceModel? @relation(fields: [voiceModelId], references: [id], onDelete: Cascade)
  customVoice   String?    // ID of the custom preset used
  audioUrl      String?    @db.Text
  inputText     String?    @db.Text // Text that was generated
  referenceText String?    @db.Text // Transcription of voice sample (if skip_transcription=false)
  status        String     @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  jobId         String?
  error         String?
  createdAt     DateTime   @default(now())

  @@map("voice_generations")
}

model VoiceUploadChunk {
  id        Int      @id @default(autoincrement())
  uploadId  String   @db.VarChar(100)
  index     Int
  total     Int
  data      String   @db.Text // Base64 chunk
  createdAt DateTime @default(now())

  @@index([uploadId])
  @@map("voice_upload_chunks")
}

model AgentPrompt {
  id        Int      @id @default(autoincrement())
  agentId   String
  promptId  Int
  type      String   // 'CORE', 'ONBOARDING', 'REFUSAL', 'SALES'
  
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prompt    Prompt   @relation(fields: [promptId], references: [id])

  @@unique([agentId, type]) // One prompt per type per agent
  @@map("agent_prompts")
}

model AgentSetting {
  id        Int      @id @default(autoincrement())
  agentId   String
  key       String   // 'voice_id', 'welcome_message', 'timezone'
  value     String

  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
  @@map("agent_settings")
}

model Conversation {
  id              Int       @id @default(autoincrement())
  contactId       String
  agentId         String?      // The agent handling this conversation
  promptId        Int
  waha_session_id String?
  status          String    @default("active") // active, paused, closed
  ai_enabled      Boolean   @default(true)
  processingLock  DateTime? // For ensuring sequential processing
  metadata        Json?     // Flexible storage for flow states (e.g. Lead Ingestion Drafts)
  lastMemoryExtraction DateTime? // When facts were last extracted to Mem0
  
  // NEW: Tracking for inbox/unread system
  lastMessageAt   DateTime? // Timestamp of last message (for sorting)
  lastMessageSender String?  // 'contact', 'ai', 'admin' - who sent the last message
  unreadCount     Int       @default(0) // Number of unread messages from contact
  lastReadByAdmin DateTime? // When admin last read the conversation
  priority        String    @default("normal") // high, normal, low
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt @default(now())
  closedAt        DateTime?
  
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agent           Agent?    @relation(fields: [agentId], references: [id])
  prompt          Prompt    @relation(fields: [promptId], references: [id])
  messages        Message[]
  messageQueue    MessageQueue[]
  supervisorAlerts SupervisorAlert[]

  @@index([status])
  @@index([contactId, status])
  @@index([agentId])
  @@index([processingLock])
  @@index([lastMessageAt]) // NEW: For sorting by activity
  @@index([priority])      // NEW: For filtering by priority
  @@map("conversations")
}


model Message {
  id              Int      @id @default(autoincrement())
  conversationId  Int
  sender          String   // 'ai', 'contact', 'admin'
  message_text    String
  waha_message_id String?  @unique
  mediaUrl        String?  // URL or Base64 of image
  status          String   @default("SENT") // SENT, DELIVERED, READ
  timestamp       DateTime @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, timestamp(sort: Desc)])
  @@index([sender])
  @@index([timestamp])
  @@map("messages")
}

model TrustLog {
  id             Int      @id @default(autoincrement())
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agentId        String?  // Multi-agent: track which agent triggered the analysis
  agent          Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
  oldScore       Int
  newScore       Int
  change         Int 
  reason         String? 
  transcript     String? 
  createdAt      DateTime @default(now())

  @@index([contactId])
  @@index([agentId])
  @@map("trust_logs")
}

// Signal-based trust tracking (replaces numeric TrustLog)
model SignalLog {
  id          Int      @id @default(autoincrement())
  agentId     String
  contactId   String
  signal      String   // The signal: RESPONSIVE, ATTACHED, DEFENSIVE, etc.
  action      String   // DETECTED or LOST
  reason      String?  // AI explanation for the detection/loss
  createdAt   DateTime @default(now())

  @@index([agentId, contactId])
  @@index([createdAt])
  @@map("signal_logs")
}

model Setting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String

  @@map("settings")
}

model MediaType {
  id          String   @id // e.g. "photo_pieds"
  description String?
  keywords    String[] // ["pieds", "feet", "orteils"]
  createdAt   DateTime @default(now())
  medias      Media[]
  requests    PendingRequest[]

  @@map("media_types")
}

model Media {
  id          Int       @id @default(autoincrement())
  typeId      String
  url         String
  sentTo      String[]  @default([]) // Array of phone numbers
  createdAt   DateTime  @default(now())
  context     String?   @db.Text // Context for AI (invisible to user)
  
  type        MediaType @relation(fields: [typeId], references: [id])

  @@map("medias")
}

model PendingRequest {
  id              String   @id @default(uuid())
  requesterPhone  String   // The contact asking
  mediaType       String   // 'image' or 'video'
  description     String   // "photo of you at the beach"
  status          String   @default("pending") // pending, fulfilled, cancelled
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  typeId          String?
  type            MediaType? @relation(fields: [typeId], references: [id])
  
  jobId           String?    // RVC Job ID
  voiceId         String?    // Target Voice
  sourceAudioUrl  String?    // Supabase URL of source audio if any

  @@index([status])
  @@index([requesterPhone])
}

model MessageQueue {
  id             String      @id @default(uuid())
  contactId      String
  contact        Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  content        String      @db.Text
  mediaUrl       String?     @db.Text
  mediaType      String?     // 'image', 'video', 'audio', 'document'
  duration       Int?        // Audio duration in ms
  scheduledAt    DateTime
  status         String      @default("PENDING") // PENDING, PROCESSING, SENT, FAILED, INVALID_EMPTY
  attempts       Int         @default(0)
  error          String?     @db.Text // Error message for failed messages
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt @default(now())
  
  @@index([status, scheduledAt])
}

model BlacklistRule {
  id        Int      @id @default(autoincrement())
  term      String   // The forbidden concept or keyword
  mediaType String   @default("all") // 'image', 'video', 'all'
  phase     String   @default("all") // 'CONNECTION', 'VULNERABILITY', 'CRISIS', 'MONEYPOT', 'all'
  agentId   String?     // If null, applies globally (or legacy)
  agent     Agent?   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([phase])
  @@map("blacklist_rules")
}


model VoiceCategory {
  id          String      @id // e.g. "greeting_shy", "refusal_polite"
  description String?
  createdAt   DateTime    @default(now())
  clips       VoiceClip[]

  @@map("voice_categories")
}

model VoiceClip {
  id          Int            @id @default(autoincrement())
  categoryId  String
  url         String
  transcript  String?        // "Hello friend"
  sentTo      String[]       @default([]) // Array of phone numbers
  sourcePhone String?        // Who recorded it
  duration    Int?           // Audio duration in ms
  createdAt   DateTime       @default(now())
  
  category    VoiceCategory  @relation(fields: [categoryId], references: [id])

  @@map("voice_clips")
}

model Payment {
  id              String   @id // PayPal Transaction ID
  amount          Decimal
  currency        String   @default("USD")
  status          String   // COMPLETED, PENDING, DENIED
  payerName       String?
  payerEmail      String?
  
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  method          String?  // e.g. "PayPal", "CashApp"
  
  rawJson         String?  // Store full webhook payload for debugging
  createdAt       DateTime @default(now())

  @@map("payments")
}

model WebhookEvent {
  id        String   @id @default(uuid())
  source    String   // 'whatsapp', 'paypal'
  payload   Json
  status    String   @default("PENDING") // PENDING, PROCESSING, PROCESSED, FAILED
  error     String?
  createdAt DateTime @default(now())
  processedAt DateTime?

  @@index([status])
  @@map("webhook_events")
}

// Incoming message queue for async processing (prevents timeout)
model IncomingQueue {
  id          Int       @id @default(autoincrement())
  payload     Json      // Full webhook payload from Baileys
  agentId     String
  // Async AI Job Tracking
  runpodJobId String?   // ID returned by RunPod /run endpoint
  
  status      String    @default("PENDING") // PENDING, PROCESSING, AI_PROCESSING, DONE, FAILED
  attempts    Int       @default(0)
  error       String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("incoming_queue")
}

// Pending payment claims awaiting admin confirmation via reaction
model PendingPaymentClaim {
  id             String   @id @default(uuid())
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agentId        String?  // Multi-agent: which agent received the payment claim
  agent          Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
  conversationId Int?
  waMessageId    String?  @unique // WhatsApp message ID sent to admin (for reaction tracking)
  claimedAmount  Decimal?
  claimedMethod  String?  // e.g. "PayPal", "CashApp", "Venmo"
  status         String   @default("PENDING") // PENDING, CONFIRMED, REJECTED
  createdAt      DateTime @default(now())
  
  @@index([contactId])
  @@index([agentId])
  @@map("pending_payment_claims")
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   // 'PAYMENT_CLAIM', 'SYSTEM', 'INFO', 'SYSTEM_ERROR', 'TTS_FAILURE'
  
  // Multi-agent: notifications can be agent-specific
  agentId   String?  // If set, notification is for this agent only
  agent     Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)
  
  // Reference to related entities
  entityId  String?  // ID of the related entity (e.g. pending_claim_id)
  metadata  Json?    // Extra data (e.g. amount, contact_name)

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
  @@index([agentId])
  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(uuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  
  // Optional: Link to a user if we have multi-user admin later
  userId    String?  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("push_subscriptions")
}

// --- ISOLATION REFACTOR MODELS ---

model AgentProfile {
  id              Int     @id @default(autoincrement())
  agentId         String     @unique
  agent           Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Identity
  baseAge         Int     @default(18)
  locale          String  @default("en-US")
  timezone        String  @default("America/Los_Angeles")
  
  // Templates
  contextTemplate String? @db.Text
  missionTemplate String? @db.Text
  identityTemplate String? @db.Text
  
  // Rules
  paymentRules    String? @db.Text
  safetyRules     String? @db.Text
  styleRules      String? @db.Text
  
  // Phase Templates
  phaseConnectionTemplate String? @db.Text
  phaseVulnerabilityTemplate String? @db.Text
  phaseCrisisTemplate String? @db.Text
  phaseMoneypotTemplate String? @db.Text

  // Payment Config
  paypalEmail     String?
  cashappTag      String?
  venmoHandle     String?
  bankAccountNumber String?
  bankRoutingNumber String?
  
  // Config
  fastTrackDays   Int     @default(2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("agent_profiles")
}

model AgentContact {
  id              String   @id @default(uuid())
  agentId         String
  contactId       String

  // State from Contact (Isolated)
  trustScore      Int      @default(0)  // DEPRECATED - kept for backward compat, use signals
  signals         String[] @default([]) // Active trust signals: ["RESPONSIVE", "ATTACHED", ...]
  phase           String   @default("CONNECTION")
  lastPhaseUpdate DateTime @default(now())
  lastTrustAnalysis DateTime @default(now())
  lastSignalAnalysis DateTime @default(now())

  // Stats
  messageCount    Int      @default(0)

  // Payment Escalation Tracking
  paymentEscalationTier    Int      @default(0)  // 0-5 (tier d'escalade actuel)
  lastRequestedAmount      Decimal? @db.Decimal(10, 2)
  lastRequestDate          DateTime?
  totalPaymentsReceived    Int      @default(0)  // compteur de paiements
  totalAmountReceived      Decimal  @default(0) @db.Decimal(10, 2)
  consecutiveRefusals      Int      @default(0)  // refus consécutifs
  lastPaymentDate          DateTime?

  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  contact         Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  stories         Story[]  // Stories narratives

  @@unique([agentId, contactId])
  @@index([agentId])
  @@index([contactId])
  @@map("agent_contacts")
}



model PendingVoiceValidation {
  id              String   @id @default(uuid())
  contactId       String   // The user who should eventually receive the voice
  agentId         String
  
  // The generated voice
  audioUrl        String
  transcript      String   @db.Text
  
  // The original generation context (for regeneration)
  originalPrompt  String?  @db.Text 
  
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  // Admin Interaction
  adminPhone      String?  // Who received the validation request
  validationMsgId String?  @unique // The WhatsApp ID of the message sent to admin
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  contact         Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("pending_voice_validations")
}

model DiscordBot {
  id          String   @id  // Discord User ID
  username    String
  
  // The agent assigned to this bot
  agentId     String?
  agent       Agent?   @relation(fields: [agentId], references: [id])
  
  lastSeen    DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("discord_bots")
}

// ============================================================================
// SUPERVISOR AI - AI Health Monitoring System
// ============================================================================

model SupervisorAlert {
  id              String   @id @default(uuid())
  agentId         String
  conversationId  Int
  contactId       String?
  
  // Classification
  agentType       String   // 'COHERENCE', 'CONTEXT', 'PHASE', 'ACTION'
  alertType       String   // 'REPETITION', 'SYSTEM_LEAK', 'UNREQUESTED_PHOTO', etc.
  severity        String   // 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL'
  
  // Contenu
  title           String   // Titre court pour le dashboard
  description     String   @db.Text  // Description complète
  evidence        Json     // Données structurées selon le type
  
  // État
  status          String   @default("NEW") // NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE
  adminNotes      String?  @db.Text
  
  // Auto-actions taken
  autoPaused      Boolean  @default(false) // Si la conversation a été auto-paused
  
  // Métadonnées
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  conversation    Conversation? @relation(fields: [conversationId], references: [id])
  contact         Contact?      @relation(fields: [contactId], references: [id])
  
  @@index([agentId, status])
  @@index([severity, status])
  @@index([agentType, createdAt])
  @@index([createdAt])
  @@map("supervisor_alerts")
}

// ============================================================================
// SYSTEM MONITORING - Error tracking and logs aggregation
// ============================================================================

model SystemLog {
  id          String   @id @default(uuid())
  
  // Source du log
  source      String   // 'whatsapp', 'discord', 'nextjs', 'cron'
  service     String?  // Sous-service spécifique (ex: 'baileys', 'openai', 'prisma')
  
  // Classification
  level       String   // 'CRITICAL', 'ERROR', 'WARN', 'INFO'
  category    String   // 'connection', 'api', 'database', 'memory', 'auth', 'system', 'general'
  
  // Contenu
  message     String   @db.Text
  context     String?  @db.Text  // Stack trace, code erreur, details
  rawLine     String?  @db.Text  // Ligne de log brute originale
  
  // Métadonnées
  metadata    Json?    // Données additionnelles (timestamp original, container, etc.)
  
  // Tracking
  isRead      Boolean  @default(false)
  readAt      DateTime?
  readBy      String?  // User ID qui a lu
  
  // Notification
  notificationCreated Boolean @default(false)  // Si une notification a été créée
  
  // TTL - Auto cleanup après 7 jours
  expiresAt   DateTime // Date d'expiration (createdAt + 7 days)
  
  createdAt   DateTime @default(now())
  
  @@index([level, isRead])
  @@index([source, createdAt])
  @@index([expiresAt])  // Pour le cleanup rapide
  @@index([createdAt(sort: Desc)])
  @@map("system_logs")
}



// ============================================================================
// LEAD PROVIDER SYSTEM - Lead ingestion and tracking
// ============================================================================

model Lead {
  id            String   @id @default(cuid())
  providerId    String   // Who added the lead
  agentId       String   // Target agent
  
  // Type & Identifier
  type          LeadType // WHATSAPP | DISCORD
  identifier    String   // WhatsApp number or Discord username
  
  // Lead Info
  age           Int?
  location      String?
  notes         String?
  context       String?
  source        String   // Where the lead was found
  
  // Status tracking
  status        LeadStatus @default(PENDING)
  
  // Business tracking
  pricePaid     Float    @default(4.0) // $4 per lead
  paidAt        DateTime?
  paidWeek      String?  // "2026-W06" for weekly tracking
  
  // Relations
  provider      User     @relation(fields: [providerId], references: [id])
  agent         Agent    @relation(fields: [agentId], references: [id])
  
  // Converted contact
  contactId     String?  @unique
  contact       Contact? @relation(fields: [contactId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([providerId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
  @@index([identifier])
  @@map("leads")
}

// Provider-Agent assignment configuration
model ProviderConfig {
  id          String @id @default(cuid())
  providerId  String @unique
  agentId     String // Target agent for all leads from this provider
  
  provider    User   @relation(fields: [providerId], references: [id])
  agent       Agent  @relation(fields: [agentId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([agentId])
  @@map("provider_configs")
}

// ==== SYSTEME DE STORIES NARRATIVES ====

enum StoryType {
  FACTURE
  SANTE
  FAMILLE
  ECOLE
  TRANSPORT
  URGENCE
  FILLER
}

enum StoryStatus {
  ACTIVE
  RESOLVED
  ESCAPED
  PENDING
}

model Story {
  id                String    @id @default(cuid())
  agentId           String
  contactId         String
  
  storyType         StoryType
  description       String
  angle             String
  promptTemplate    String    @db.Text
  
  amount            Int?
  status            StoryStatus @default(ACTIVE)
  
  // Liens narratifs
  previousStoryId   String?
  previousStory     Story?    @relation("StoryChain", fields: [previousStoryId], references: [id])
  nextStories       Story[]   @relation("StoryChain")
  
  // Timing
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?
  lastMentionedAt   DateTime  @default(now())
  
  // Relations
  agentContact      AgentContact @relation(fields: [agentId, contactId], references: [agentId, contactId])
  
  @@unique([agentId, contactId, description])
  @@index([agentId, contactId, status])
  @@index([agentId, contactId, createdAt])
  @@map("stories")
}
