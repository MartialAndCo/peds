generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Prompt {
  id            Int      @id @default(autoincrement())
  name          String
  system_prompt String
  model         String   @default("venice-uncensored")
  temperature   Decimal  @default(0.7)
  max_tokens    Int      @default(500)
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  conversations Conversation[]

  @@map("prompts")
}

model Contact {
  id              String         @id @default(cuid())
  phone_whatsapp  String         @unique
  name            String?
  source          String?        @default("manual")
  notes           String?
  status          String         @default("new") // active, archive, blacklisted
  
  // State-Aware Agent Fields
  agentPhase      String         @default("CONNECTION") // CONNECTION, VULNERABILITY, CRISIS
  trustScore      Int            @default(0)
  lastPhaseUpdate DateTime       @default(now())
  lastTrustAnalysis DateTime     @default(now())
  
  profile         Json?          // Stores extracted info: { age, job, location, name, ... }

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  conversations   Conversation[]
  payments        Payment[]
  messageQueue    MessageQueue[]

  @@map("contacts")
}

model Conversation {
  id              Int       @id @default(autoincrement())
  contactId       String
  promptId        Int
  waha_session_id String?
  status          String    @default("active") // active, paused, closed
  ai_enabled      Boolean   @default(true)
  processingLock  DateTime? // For ensuring sequential processing
  metadata        Json?     // Flexible storage for flow states (e.g. Lead Ingestion Drafts)
  createdAt       DateTime  @default(now())
  closedAt        DateTime?
  
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  prompt          Prompt    @relation(fields: [promptId], references: [id])
  messages        Message[]
  messageQueue    MessageQueue[]

  @@map("conversations")
}

model Message {
  id              Int      @id @default(autoincrement())
  conversationId  Int
  sender          String   // 'ai', 'contact', 'admin'
  message_text    String
  waha_message_id String?  @unique
  timestamp       DateTime @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Setting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String

  @@map("settings")
}

model MediaType {
  id          String   @id // e.g. "photo_pieds"
  description String?
  keywords    String[] // ["pieds", "feet", "orteils"]
  createdAt   DateTime @default(now())
  medias      Media[]
  requests    PendingRequest[]

  @@map("media_types")
}

model Media {
  id          Int       @id @default(autoincrement())
  typeId      String
  url         String
  sentTo      String[]  @default([]) // Array of phone numbers
  createdAt   DateTime  @default(now())
  
  type        MediaType @relation(fields: [typeId], references: [id])

  @@map("medias")
}

model PendingRequest {
  id              String   @id @default(uuid())
  requesterPhone  String   // The contact asking
  mediaType       String   // 'image' or 'video'
  description     String   // "photo of you at the beach"
  status          String   @default("pending") // pending, fulfilled, cancelled
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  typeId          String?
  type            MediaType? @relation(fields: [typeId], references: [id])
}

model MessageQueue {
  id             String      @id @default(uuid())
  contactId      String
  contact        Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  content        String      @db.Text
  mediaUrl       String?     @db.Text
  mediaType      String?     // 'image', 'video', 'audio', 'document'
  scheduledAt    DateTime
  status         String      @default("PENDING") // PENDING, SENT, FAILED
  attempts       Int         @default(0)
  createdAt      DateTime    @default(now())
  
  @@index([status, scheduledAt])
}

model BlacklistRule {
  id        Int      @id @default(autoincrement())
  term      String   // The forbidden concept or keyword
  mediaType String   @default("all") // 'image', 'video', 'all'
  createdAt DateTime @default(now())


  @@map("blacklist_rules")
}


model VoiceCategory {
  id          String      @id // e.g. "greeting_shy", "refusal_polite"
  description String?
  createdAt   DateTime    @default(now())
  clips       VoiceClip[]

  @@map("voice_categories")
}

model VoiceClip {
  id          Int            @id @default(autoincrement())
  categoryId  String
  url         String
  transcript  String?        // "Hello friend"
  sentTo      String[]       @default([]) // Array of phone numbers
  sourcePhone String?        // Who recorded it
  createdAt   DateTime       @default(now())
  
  category    VoiceCategory  @relation(fields: [categoryId], references: [id])

  @@map("voice_clips")
}

model Payment {
  id              String   @id // PayPal Transaction ID
  amount          Decimal
  currency        String   @default("USD")
  status          String   // COMPLETED, PENDING, DENIED
  payerName       String?
  payerEmail      String?
  
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  
  rawJson         String?  // Store full webhook payload for debugging
  createdAt       DateTime @default(now())

  @@map("payments")
}
