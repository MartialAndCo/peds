generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Prompt {
  id            Int      @id @default(autoincrement())
  name          String
  system_prompt String
  model         String   @default("venice-uncensored")
  temperature   Decimal  @default(0.7)
  max_tokens    Int      @default(500)
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())
  conversations Conversation[]
  agentPrompts  AgentPrompt[]

  @@map("prompts")
}

model Contact {
  id              String         @id @default(cuid())
  phone_whatsapp  String         @unique
  name            String?
  source          String?        @default("manual")
  notes           String?
  status          String         @default("new") // active, archive, blacklisted, merged
  isHidden        Boolean        @default(false) // Hide from dashboard (e.g. Lead Source)
  testMode        Boolean        @default(false) // Bypass AI delays for testing
  
  // Merge tracking - if this contact was merged into another
  mergedIntoId    String?        // ID of the contact this was merged into
  
  // State-Aware Agent Fields
  agentPhase      String         @default("CONNECTION") // CONNECTION, VULNERABILITY, CRISIS
  trustScore      Int            @default(0)
  lastPhaseUpdate DateTime       @default(now())
  lastTrustAnalysis DateTime     @default(now())
  
  profile         Json?          // Stores extracted info: { age, job, location, name, ... }

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  conversations   Conversation[]
  payments        Payment[]
  messageQueue    MessageQueue[]
  trustLogs       TrustLog[]
  paymentClaims   PendingPaymentClaim[]

  @@index([status])
  @@index([source])
  @@index([isHidden])
  @@index([agentPhase])
  @@index([mergedIntoId])
  @@map("contacts")
}


model Agent {
  id        Int      @id @default(autoincrement())
  name      String   // e.g. "Lena", "Maxime"
  phone     String   @unique // The WhatsApp number connected to this agent
  color     String   @default("#000000") // For UI distinction
  isActive  Boolean  @default(true)
  
  // Legacy field, helpful for migration or default fallback
  promptId  Int?     

  voiceModelId Int?
  voiceModel   VoiceModel? @relation(fields: [voiceModelId], references: [id])
  operatorGender String   @default("MALE") // 'MALE', 'FEMALE'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversations Conversation[]
  agentPrompts  AgentPrompt[]
  settings      AgentSetting[]
  blacklistRules BlacklistRule[]
  
  @@map("agents")
}

model VoiceModel {
  id        Int      @id @default(autoincrement())
  name      String   // e.g. "Homer", "American 1"
  url       String   // HuggingFace URL
  gender    String   @default("FEMALE") // 'MALE', 'FEMALE'
  
  // RVC Parameters
  indexRate   Decimal  @default(0.75)
  protect     Decimal  @default(0.33)
  rmsMixRate  Decimal  @default(0.25)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  agents    Agent[]
  generations VoiceGeneration[]

  @@map("voice_models")
}

model VoiceGeneration {
  id           Int        @id @default(autoincrement())
  voiceModelId Int
  voiceModel   VoiceModel @relation(fields: [voiceModelId], references: [id], onDelete: Cascade)
  audioUrl     String?    @db.Text
  status       String     @default("COMPLETED") // PENDING, PROCESSING, COMPLETED, FAILED
  jobId        String?
  error        String?
  createdAt    DateTime   @default(now())

  @@map("voice_generations")
}

model VoiceUploadChunk {
  id        Int      @id @default(autoincrement())
  uploadId  String   @db.VarChar(100)
  index     Int
  total     Int
  data      String   @db.Text // Base64 chunk
  createdAt DateTime @default(now())

  @@index([uploadId])
  @@map("voice_upload_chunks")
}

model AgentPrompt {
  id        Int      @id @default(autoincrement())
  agentId   Int
  promptId  Int
  type      String   // 'CORE', 'ONBOARDING', 'REFUSAL', 'SALES'
  
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  prompt    Prompt   @relation(fields: [promptId], references: [id])

  @@unique([agentId, type]) // One prompt per type per agent
  @@map("agent_prompts")
}

model AgentSetting {
  id        Int      @id @default(autoincrement())
  agentId   Int
  key       String   // 'voice_id', 'welcome_message', 'timezone'
  value     String

  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
  @@map("agent_settings")
}

model Conversation {
  id              Int       @id @default(autoincrement())
  contactId       String
  agentId         Int?      // The agent handling this conversation
  promptId        Int
  waha_session_id String?
  status          String    @default("active") // active, paused, closed
  ai_enabled      Boolean   @default(true)
  processingLock  DateTime? // For ensuring sequential processing
  metadata        Json?     // Flexible storage for flow states (e.g. Lead Ingestion Drafts)
  lastMemoryExtraction DateTime? // When facts were last extracted to Mem0
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt @default(now())
  closedAt        DateTime?
  
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  agent           Agent?    @relation(fields: [agentId], references: [id])
  prompt          Prompt    @relation(fields: [promptId], references: [id])
  messages        Message[]
  messageQueue    MessageQueue[]

  @@index([status])
  @@index([contactId, status])
  @@index([agentId])
  @@index([processingLock])
  @@map("conversations")
}


model Message {
  id              Int      @id @default(autoincrement())
  conversationId  Int
  sender          String   // 'ai', 'contact', 'admin'
  message_text    String
  waha_message_id String?  @unique
  mediaUrl        String?  // URL or Base64 of image
  timestamp       DateTime @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, timestamp(sort: Desc)])
  @@index([sender])
  @@index([timestamp])
  @@map("messages")
}

model TrustLog {
  id             Int      @id @default(autoincrement())
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  oldScore       Int
  newScore       Int
  change         Int 
  reason         String? 
  transcript     String? 
  createdAt      DateTime @default(now())

  @@index([contactId])
  @@map("trust_logs")
}

model Setting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String

  @@map("settings")
}

model MediaType {
  id          String   @id // e.g. "photo_pieds"
  description String?
  keywords    String[] // ["pieds", "feet", "orteils"]
  createdAt   DateTime @default(now())
  medias      Media[]
  requests    PendingRequest[]

  @@map("media_types")
}

model Media {
  id          Int       @id @default(autoincrement())
  typeId      String
  url         String
  sentTo      String[]  @default([]) // Array of phone numbers
  createdAt   DateTime  @default(now())
  
  type        MediaType @relation(fields: [typeId], references: [id])

  @@map("medias")
}

model PendingRequest {
  id              String   @id @default(uuid())
  requesterPhone  String   // The contact asking
  mediaType       String   // 'image' or 'video'
  description     String   // "photo of you at the beach"
  status          String   @default("pending") // pending, fulfilled, cancelled
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  typeId          String?
  type            MediaType? @relation(fields: [typeId], references: [id])
  
  jobId           String?    // RVC Job ID
  voiceId         String?    // Target Voice
  sourceAudioUrl  String?    // Supabase URL of source audio if any

  @@index([status])
  @@index([requesterPhone])
}

model MessageQueue {
  id             String      @id @default(uuid())
  contactId      String
  contact        Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  content        String      @db.Text
  mediaUrl       String?     @db.Text
  mediaType      String?     // 'image', 'video', 'audio', 'document'
  duration       Int?        // Audio duration in ms
  scheduledAt    DateTime
  status         String      @default("PENDING") // PENDING, SENT, FAILED
  attempts       Int         @default(0)
  createdAt      DateTime    @default(now())
  
  @@index([status, scheduledAt])
}

model BlacklistRule {
  id        Int      @id @default(autoincrement())
  term      String   // The forbidden concept or keyword
  mediaType String   @default("all") // 'image', 'video', 'all'
  agentId   Int?     // If null, applies globally (or legacy)
  agent     Agent?   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())


  @@map("blacklist_rules")
}


model VoiceCategory {
  id          String      @id // e.g. "greeting_shy", "refusal_polite"
  description String?
  createdAt   DateTime    @default(now())
  clips       VoiceClip[]

  @@map("voice_categories")
}

model VoiceClip {
  id          Int            @id @default(autoincrement())
  categoryId  String
  url         String
  transcript  String?        // "Hello friend"
  sentTo      String[]       @default([]) // Array of phone numbers
  sourcePhone String?        // Who recorded it
  duration    Int?           // Audio duration in ms
  createdAt   DateTime       @default(now())
  
  category    VoiceCategory  @relation(fields: [categoryId], references: [id])

  @@map("voice_clips")
}

model Payment {
  id              String   @id // PayPal Transaction ID
  amount          Decimal
  currency        String   @default("USD")
  status          String   // COMPLETED, PENDING, DENIED
  payerName       String?
  payerEmail      String?
  
  contactId       String?
  contact         Contact? @relation(fields: [contactId], references: [id])
  
  rawJson         String?  // Store full webhook payload for debugging
  createdAt       DateTime @default(now())

  @@map("payments")
}

model WebhookEvent {
  id        String   @id @default(uuid())
  source    String   // 'whatsapp', 'paypal'
  payload   Json
  status    String   @default("PENDING") // PENDING, PROCESSING, PROCESSED, FAILED
  error     String?
  createdAt DateTime @default(now())
  processedAt DateTime?

  @@index([status])
  @@map("webhook_events")
}

// Incoming message queue for async processing (prevents timeout)
model IncomingQueue {
  id          Int       @id @default(autoincrement())
  payload     Json      // Full webhook payload from Baileys
  agentId     Int
  // Async AI Job Tracking
  runpodJobId String?   // ID returned by RunPod /run endpoint
  
  status      String    @default("PENDING") // PENDING, PROCESSING, AI_PROCESSING, DONE, FAILED
  attempts    Int       @default(0)
  error       String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("incoming_queue")
}

// Pending payment claims awaiting admin confirmation via reaction
model PendingPaymentClaim {
  id             String   @id @default(uuid())
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  conversationId Int?
  waMessageId    String?  @unique // WhatsApp message ID sent to admin (for reaction tracking)
  claimedAmount  Decimal?
  claimedMethod  String?  // e.g. "PayPal", "CashApp", "Venmo"
  status         String   @default("PENDING") // PENDING, CONFIRMED, REJECTED
  createdAt      DateTime @default(now())
  
  @@index([status])
  @@index([contactId])
  @@map("pending_payment_claims")
}
